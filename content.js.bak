// MeTheYou Content Script - ìœ íŠœë¸Œ í˜ì´ì§€ì— pill ë²„íŠ¼ë§Œ í‘œì‹œ

let currentVideoId = null;
let pillButton = null;
let retryCount = 0;

// Pill ë²„íŠ¼ ìƒì„±
function createPillButton() {
  const button = document.createElement('button');
  button.className = 'metheyou-pill-button loading';
  button.id = 'metheyou-pill';
  button.innerHTML = `
    <span class="metheyou-pill-icon">ğŸ”</span>
    <span class="metheyou-pill-text">ì¡°íšŒ ì¤‘...</span>
  `;
  return button;
}

// Pill ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updatePillButton(state, data = {}) {
  if (!pillButton) return;
  
  const icon = pillButton.querySelector('.metheyou-pill-icon');
  const text = pillButton.querySelector('.metheyou-pill-text');
  
  pillButton.className = 'metheyou-pill-button';
  
  switch (state) {
    case 'loading':
      pillButton.classList.add('loading');
      icon.textContent = 'ğŸ”';
      text.textContent = 'ì¡°íšŒ ì¤‘...';
      pillButton.onclick = null;
      break;
      
    case 'analyze':
      pillButton.classList.add('analyze');
      icon.textContent = 'âœ¨';
      text.textContent = 'ë¶„ì„í•˜ê¸°';
      pillButton.onclick = () => {
        alert('ë¶„ì„ ê¸°ëŠ¥ì€ í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—…ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      };
      break;
      
    case 'score':
      const score = data.score || 0;
      let level = '';
      
      if (score >= 80) {
        pillButton.classList.add('score', 'score-high');
        level = 'ë§¤ìš° ì•ˆì „';
      } else if (score >= 60) {
        pillButton.classList.add('score', 'score-medium');
        level = 'ì•ˆì „';
      } else if (score >= 40) {
        pillButton.classList.add('score', 'score-medium');
        level = 'ë³´í†µ';
      } else {
        pillButton.classList.add('score', 'score-low');
        level = 'ì£¼ì˜';
      }
      
      icon.textContent = score >= 60 ? 'âœ…' : 'âš ï¸';
      text.textContent = `ì ìˆ˜: ${score} (${level})`;
      pillButton.onclick = () => {
        alert(`ë¶„ì„ ì˜ê²¬: ${data.description || 'ì •ë³´ ì—†ìŒ'}`);
      };
      break;
  }
}

// YouTube ì»¨íŠ¸ë¡¤ ì˜ì—­ì— ë²„íŠ¼ ì¶”ê°€ (ë” ê³µê²©ì ìœ¼ë¡œ ì¬ì‹œë„)
function attachPillButton() {
  // ê¸°ì¡´ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ì œê±°
  const existing = document.getElementById('metheyou-pill');
  if (existing) {
    existing.remove();
  }
  
  // ì—¬ëŸ¬ ì„ íƒì ì‹œë„
  const selectors = [
    'ytd-menu-renderer.ytd-watch-metadata #top-level-buttons-computed',
    '#top-level-buttons-computed',
    '#top-level-buttons',
    'ytd-menu-renderer #top-level-buttons-computed',
    '#segmented-like-button',
    '#actions'
  ];
  
  let targetContainer = null;
  for (const selector of selectors) {
    const elem = document.querySelector(selector);
    if (elem) {
      targetContainer = elem;
      console.log('[MeTheYou] ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ë°œê²¬:', selector);
      break;
    }
  }
  
  if (!targetContainer) {
    retryCount++;
    if (retryCount < 20) {
      console.warn(`[MeTheYou] ì»¨í…Œì´ë„ˆ ì°¾ê¸° ì‹¤íŒ¨ (${retryCount}/20), 1ì´ˆ í›„ ì¬ì‹œë„...`);
      setTimeout(attachPillButton, 1000);
    } else {
      console.error('[MeTheYou] ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. DOM êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    }
    return;
  }
  
  pillButton = createPillButton();
  targetContainer.appendChild(pillButton);
  retryCount = 0;
  console.log('[MeTheYou] âœ… Pill ë²„íŠ¼ ì¶”ê°€ ì™„ë£Œ!');
}

// ë¶„ì„ ìœ„ì ¯ ìƒì„±
function createAnalysisWidget(result) {
  // ê¸°ì¡´ ìœ„ì ¯ ì œê±°
  if (analysisWidget && analysisWidget.parentNode) {
    analysisWidget.remove();
  }
  
  const widget = document.createElement('div');
  widget.id = 'metheyou-widget';
  widget.className = 'metheyou-widget';
  
  const scoreColor = getScoreColor(result.score);
  const scoreLevel = getScoreLevel(result.score);
  
  widget.innerHTML = `
    <div class="metheyou-header">
      <div class="metheyou-logo">
        <span class="metheyou-icon">ğŸ¬</span>
        <h3 class="metheyou-title">ë¯¿ì–´ìœ </h3>
      </div>
      <button class="metheyou-close" id="metheyou-close">Ã—</button>
    </div>
    
    <div class="metheyou-content">
      <div class="metheyou-score-container">
        <div class="metheyou-score" style="color: ${scoreColor};">${result.score}</div>
        <div class="metheyou-score-label">/ 100ì </div>
        <div class="metheyou-score-level" style="color: ${scoreColor};">${scoreLevel}</div>
      </div>
      
      <div class="metheyou-section">
        <div class="metheyou-section-title">ë¶„ì„ ì˜ê²¬</div>
        <div class="metheyou-description">${result.description}</div>
      </div>
      
      ${result.tags ? `
        <div class="metheyou-section">
          <div class="metheyou-section-title">íƒœê·¸</div>
          <div class="metheyou-tags">
            ${result.tags.split(',').map(tag => 
              `<span class="metheyou-tag">${tag.trim()}</span>`
            ).join('')}
          </div>
        </div>
      ` : ''}
      
      <div class="metheyou-meta">
        <div class="metheyou-meta-item">
          <span class="metheyou-meta-label">ì±„ë„:</span>
          <span class="metheyou-meta-value">${result.channel_name || '-'}</span>
        </div>
        <div class="metheyou-meta-item">
          <span class="metheyou-meta-label">ê²Œì‹œì¼:</span>
          <span class="metheyou-meta-value">${result.published_at || '-'}</span>
        </div>
      </div>
    </div>
    
    <div class="metheyou-footer">
      <span class="metheyou-powered">Powered by AI</span>
    </div>
  `;
  
  analysisWidget = widget;
  return widget;
}

// ë¡œë”© ìœ„ì ¯ ìƒì„±
function createLoadingWidget(statusText = 'ë¶„ì„ ì¤‘...') {
  const widget = document.createElement('div');
  widget.id = 'metheyou-widget';
  widget.className = 'metheyou-widget metheyou-loading';
  
  widget.innerHTML = `
    <div class="metheyou-header">
      <div class="metheyou-logo">
        <h3 class="metheyou-title">ë¯¿ì–´ìœ </h3>
      </div>
      <button class="metheyou-close" id="metheyou-close">Ã—</button>
    </div>
    
    <div class="metheyou-content">
      <div class="metheyou-loading-container">
        <div class="metheyou-spinner"></div>
        <div class="metheyou-loading-text">${statusText}</div>
        <div class="metheyou-loading-subtext">ì˜ìƒì„ AIë¡œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>
  `;
  
  return widget;
}

// ì—ëŸ¬ ìœ„ì ¯ ìƒì„±
function createErrorWidget(message) {
  const widget = document.createElement('div');
  widget.id = 'metheyou-widget';
  widget.className = 'metheyou-widget metheyou-error';
  
  widget.innerHTML = `
    <div class="metheyou-header">
      <div class="metheyou-logo">
        <h3 class="metheyou-title">ë¯¿ì–´ìœ </h3>
      </div>
      <button class="metheyou-close" id="metheyou-close">Ã—</button>
    </div>
    
    <div class="metheyou-content">
      <div class="metheyou-error-container">
        <div class="metheyou-error-icon">âš ï¸</div>
        <div class="metheyou-error-text">${message}</div>
      </div>
    </div>
  `;
  
  return widget;
}

// ìœ„ì ¯ì„ í˜ì´ì§€ì— í‘œì‹œ
function showWidget(widget) {
  // ê¸°ì¡´ ìœ„ì ¯ ì œê±°
  const existing = document.getElementById('metheyou-widget');
  if (existing) {
    existing.remove();
  }
  
  document.body.appendChild(widget);
  analysisWidget = widget;
  
  // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  const closeBtn = widget.querySelector('#metheyou-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      widget.remove();
      analysisWidget = null;
    });
  }
}

// ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
function getStatusText(status) {
  const statusMap = {
    'ready': 'ë¶„ì„ ëŒ€ê¸° ì¤‘...',
    'extract': 'ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì¤‘... (20%)',
    'trans': 'ìë§‰ ì¶”ì¶œ ì¤‘... (40%)',
    'analysis': 'AI ë¶„ì„ ì§„í–‰ ì¤‘... (60%)',
    'saving': 'ê²°ê³¼ ì €ì¥ ì¤‘... (80%)',
    'success': 'ë¶„ì„ ì™„ë£Œ!',
    'error': 'ë¶„ì„ ì‹¤íŒ¨'
  };
  return statusMap[status] || status;
}

// ë©”ì¸ ë¶„ì„ í•¨ìˆ˜
async function analyzeCurrentVideo() {
  const videoId = getYouTubeVideoId(window.location.href);
  
  if (!videoId) {
    console.log('[MeTheYou] ë¹„ë””ì˜¤ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ì´ë¯¸ ê°™ì€ ë¹„ë””ì˜¤ë¥¼ ë¶„ì„ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  if (currentVideoId === videoId && analysisWidget) {
    return;
  }
  
  currentVideoId = videoId;
  console.log('[MeTheYou] ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘:', videoId);
  
  try {
    // 1. ìºì‹œ í™•ì¸
    const cached = await MeTheYouAPI.searchAnalysis(videoId);
    
    if (cached.found) {
      console.log('[MeTheYou] ìºì‹œëœ ê²°ê³¼ ì‚¬ìš©');
      const widget = createAnalysisWidget(cached);
      showWidget(widget);
      return;
    }
    
    // 2. ìƒˆë¡œìš´ ë¶„ì„ ìš”ì²­
    console.log('[MeTheYou] ìƒˆë¡œìš´ ë¶„ì„ ìš”ì²­');
    updatePillButton('loading');
    
    const requestResult = await MeTheYouAPI.requestAnalysis(videoId);
    
    if (requestResult.taskid === -1) {
      throw new Error('ë¶„ì„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
    
    const taskId = requestResult.taskid;
    console.log('[MeTheYou] ì‘ì—… ID:', taskId);
    
    // 3. ìƒíƒœ í´ë§ (ìµœëŒ€ 5ë¶„, 2ì´ˆ ê°„ê²©)
    for (let i = 0; i < 150; i++) {
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const statusResult = await MeTheYouAPI.checkStatus(taskId);
      console.log(`[MeTheYou] ìƒíƒœ [${i + 1}/150]:`, statusResult.status);
      
      // ë¡œë”© ìœ„ì ¯ ì—…ë°ì´íŠ¸
      conPill ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ë¡œë”© ìƒíƒœ ìœ ì§€)
      updatePillButton('loading'
      if (statusResult.status === 'success') {
        // 4. ê²°ê³¼ ì¡°íšŒ
        const result = await MeTheYouAPI.getResult(taskId);
        
        if (result.video_id !== -1) {
          console.log('[MeTheYou] ë¶„ì„ ì™„ë£Œ:', result);
          const resultWidget = createAnalysisWidget(result);
          showWidget(resultWidget);
        } else {
          updatePillButton('score', resul
        return;
      } else if (statusResult.status === 'error') {
        throw new Error('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }
    
    throw new Error('ë¶„ì„ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤ (5ë¶„)');
    
  } catch (error) {
    console.error('[MeTheYou] ì˜¤ë¥˜:', error);
    const errorWidget = createErrorWidget(error.message);
    showWidget(errorWidget);
  }
}
updatePillButton('analyze');
    
// URL ë³€ê²½ ê°ì§€
function observeUrlChange() {
  let lastUrl = location.href;
  
  new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
      lastUrl = url;
      onUrlChange();
    }
  }).observe(document, { subtree: true, childList: true });
}

// URLì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ì²˜ë¦¬
function onUrlChange() {
  const videoId = getYouTubeVideoId(window.location.href);
  
  // watch í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ë²„íŠ¼ê³¼ ìœ„ì ¯ ì œê±°
  if (!videoId || window.location.pathname !== '/watch') {
    if (pillButton && pillButton.parentNode) {
      pillButton.remove();
      pillButton = null;
    }
    if (analysisWidget && analysisWidget.parentNode) {
      analysisWidget.remove();
      analysisWidget = null;
    }
    currentVideoId = null;
  } else {
    // watch í˜ì´ì§€ë¡œ ë³€ê²½ë˜ë©´ ìë™ìœ¼ë¡œ ìºì‹œ í™•ì¸
    checkCacheOnLoad();
  }
}

// ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ (popupì—ì„œ ìš”ì²­)
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'analyze') {
    analyzeCurrentVideo();
    sendResponse({ success: true });
  } else if (request.action === 'getVideoId') {
    const videoId = getYouTubeVideoId(window.location.href);
    sendResponse({ videoId: videoId });
  }
  return true;
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìºì‹œ í™•ì¸
async function checkCacheOnLoad() {
  const videoId = getYouTubeVideoId(window.location.href);
  
  if (!videoId || window.location.pathname !== '/watch') {
    console.log('[MeTheYou] watch í˜ì´ì§€ê°€ ì•„ë‹ˆê±°ë‚˜ ë¹„ë””ì˜¤ ID ì—†ìŒ');
    return;
  }
  
  // ì´ë¯¸ ê°™ì€ ë¹„ë””ì˜¤ë¥¼ í™•ì¸í–ˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
  if (currentVideoId === videoId) {
    return;
  }
  
  currentVideoId = videoId;
  console.log('[MeTheYou] í˜ì´ì§€ ë¡œë“œ - ìºì‹œ í™•ì¸ ì‹œì‘:', videoId);
  
  // Pill ë²„íŠ¼ ì¶”ê°€ (ì—†ìœ¼ë©´)
  if (!pillButton || !document.body.contains(pillButton)) {
    attachPillButton();
  }
  
  // ë¡œë”© ìƒíƒœë¡œ ì„¤ì •
  updatePillButton('loading');
  
  try {
    // ìºì‹œëœ ê²°ê³¼ë§Œ í™•ì¸ (ìë™ ë¶„ì„ ìš”ì²­ì€ í•˜ì§€ ì•ŠìŒ)
    const cached = await MeTheYouAPI.searchAnalysis(videoId);
    
    if (cached.found) {
      console.log('[MeTheYou] ìºì‹œëœ ë¶„ì„ ê²°ê³¼ ë°œê²¬');
      updatePillButton('score', cached);
    } else {
      console.log('[MeTheYou] ë¯¸ë¶„ì„ ì˜ìƒ - ë¶„ì„ ë²„íŠ¼ í‘œì‹œ');
      updatePillButton('analyze');
    }
  } catch (error) {
    console.error('[MeTheYou] ìºì‹œ í™•ì¸ ì˜¤ë¥˜:', error);
    updatePillButton('analyze');
  }
}

// ì´ˆê¸°í™”
function init() {
  console.log('[MeTheYou] ì´ˆê¸°í™” ì™„ë£Œ - ìë™ ìºì‹œ í™•ì¸ í™œì„±í™”');
  
  // URL ë³€ê²½ ê°ì§€ ì‹œì‘
  observeUrlChange();
  
  // í˜„ì¬ í˜ì´ì§€ ìºì‹œ í™•ì¸
  checkCacheOnLoad();
}

// í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
